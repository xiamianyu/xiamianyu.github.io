<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  

  <title>APK代码相似度计算</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
    <link rel="icon" href="/images/favicon.webp">
  

  <link rel="preload" href="/fonts/Montserrat.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/RobotoMono.woff2" as="font" type="font/woff2" crossorigin>

  <!-- site css -->
  
<link rel="stylesheet" href="/css/fonts.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <link href="/vendor/fancybox/5.0.36/fancybox.css" rel="stylesheet">
  <script src="/vendor/fancybox/5.0.36/fancybox.umd.js" defer></script>
  
<script src="/js/fancybox.js"></script>


  
    <script>
      window.__mermaidInitConfig = {
        theme: 'default'
      };
    </script>
    <script src='/vendor/mermaid/11.12.0/mermaid.min.js' defer onload="try{if(window.mermaid){ mermaid.initialize(window.__mermaidInitConfig); }}catch(e){}"></script>
  
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="夏眠鱼" type="application/atom+xml">
</head>
  <body>
    <div id="app">
      <div class="header">
  <a href="/">夏眠鱼</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="tags" target="" href="/tags/">
      <i class="iconfont icon-tags"></i>
    </a>
  
    <a title="about" target="" href="/about/">
      <i class="iconfont icon-envelope"></i>
    </a>
  
</p>

      <div class="main">
        <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  };
</script>
<script id="MathJax-script" src="/vendor/mathjax/3.2.2/es5/tex-chtml.js" defer></script>

<div class="post">
  <div class="date-tags-container">
    <h3 class="date">
      Jun 24, 2025
    </h3>
    
      <div class="post-tags">
        
          <a href="/tags/android/" class="tag-link">android</a>
        
      </div>
    
  </div>
  <h1>
    APK代码相似度计算
  </h1>
  <div class="content markdown-body">
    <h2 id="算法"><a href="#算法" class="headerlink" title="算法"></a>算法</h2><p>通过多维度特征融合计算相似度：</p>
<pre class="mermaid">graph LR
    A[APK] --> B(操作码序列)
    A --> C(资源特征)
    A --> D(原生库)
    A --> E(布局结构)
    B --> F[相似度计算]
    C --> F
    D --> F
    E --> F
    F --> G{综合评分}</pre>

<h2 id="用法"><a href="#用法" class="headerlink" title="用法"></a>用法</h2><p><code>python3 apk_sim.py &lt;apk1&gt; &lt;apk2&gt;</code></p>
<h2 id="脚本"><a href="#脚本" class="headerlink" title="脚本"></a>脚本</h2><p>apk_sim.py</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python3</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 执行流程：</span></span><br><span class="line"><span class="comment"># 1. 通过命令行输入两个APK文件路径</span></span><br><span class="line"><span class="comment"># 2. 为每个APK创建临时目录用于反编译</span></span><br><span class="line"><span class="comment"># 3. 反编译APK（使用apktool）</span></span><br><span class="line"><span class="comment"># 4. 分别提取以下特征：</span></span><br><span class="line"><span class="comment">#    a. 操作码序列和向量（从smali代码）</span></span><br><span class="line"><span class="comment">#    b. 控制流特征（分支、循环、异常等）</span></span><br><span class="line"><span class="comment">#    c. 资源特征（包括AndroidManifest.xml、资源文件哈希、布局文件结构）</span></span><br><span class="line"><span class="comment">#    d. 原生库特征（ELF头、节名称）</span></span><br><span class="line"><span class="comment"># 5. 组合这些特征，使用MinHash计算结构相似度（包括资源、控制流、原生库和操作码序列指纹）</span></span><br><span class="line"><span class="comment"># 6. 计算操作码向量的余弦相似度</span></span><br><span class="line"><span class="comment"># 7. 计算资源特征的MinHash相似度（Jaccard相似度）</span></span><br><span class="line"><span class="comment"># 8. 加权综合相似度 = 操作码权重 * 操作码相似度 + 结构权重 * 结构相似度 + 资源权重 * 资源相似度</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> re</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> glob</span><br><span class="line"><span class="keyword">import</span> json</span><br><span class="line"><span class="keyword">import</span> hashlib</span><br><span class="line"><span class="keyword">import</span> tempfile</span><br><span class="line"><span class="keyword">import</span> subprocess</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> zipfile</span><br><span class="line"><span class="keyword">from</span> datasketch <span class="keyword">import</span> MinHash</span><br><span class="line"><span class="keyword">from</span> sklearn.metrics.pairwise <span class="keyword">import</span> cosine_similarity</span><br><span class="line"><span class="keyword">from</span> collections <span class="keyword">import</span> defaultdict</span><br><span class="line"><span class="keyword">from</span> bs4 <span class="keyword">import</span> BeautifulSoup</span><br><span class="line"></span><br><span class="line"><span class="comment"># 全局配置</span></span><br><span class="line">NUM_PERM = <span class="number">256</span>      <span class="comment"># MinHash排列数</span></span><br><span class="line">OPCODE_SIM_WEIGHT = <span class="number">0.2</span> <span class="comment"># 操作码相似度权重</span></span><br><span class="line">STRUCTURE_SIM_WEIGHT = <span class="number">0.4</span> <span class="comment"># 结构相似度权重</span></span><br><span class="line">RESOURCE_SIM_WEIGHT = <span class="number">0.4</span> <span class="comment"># 资源相似度权重</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 预编译正则表达式，提高性能</span></span><br><span class="line">OPCODE_PATTERN = re.<span class="built_in">compile</span>(<span class="string">r&#x27;^\s*([a-zA-Z0-9/-]+)&#x27;</span>)</span><br><span class="line">ELF_SECTION_PATTERN = re.<span class="built_in">compile</span>(<span class="string">br&#x27;\.(text|rodata|data|bss|plt)&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 所有可能的Dalvik操作码（设为全局常量）</span></span><br><span class="line">ALL_OPCODES = <span class="built_in">set</span>([</span><br><span class="line">    <span class="string">&#x27;nop&#x27;</span>, <span class="string">&#x27;move&#x27;</span>, <span class="string">&#x27;move/from16&#x27;</span>, <span class="string">&#x27;move/16&#x27;</span>, <span class="string">&#x27;move-wide&#x27;</span>, <span class="string">&#x27;move-wide/from16&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;move-wide/16&#x27;</span>, <span class="string">&#x27;move-object&#x27;</span>, <span class="string">&#x27;move-object/from16&#x27;</span>, <span class="string">&#x27;move-object/16&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;move-result&#x27;</span>, <span class="string">&#x27;move-result-wide&#x27;</span>, <span class="string">&#x27;move-result-object&#x27;</span>, <span class="string">&#x27;move-exception&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;return-void&#x27;</span>, <span class="string">&#x27;return&#x27;</span>, <span class="string">&#x27;return-wide&#x27;</span>, <span class="string">&#x27;return-object&#x27;</span>, <span class="string">&#x27;const/4&#x27;</span>, <span class="string">&#x27;const/16&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;const&#x27;</span>, <span class="string">&#x27;const/high16&#x27;</span>, <span class="string">&#x27;const-wide/16&#x27;</span>, <span class="string">&#x27;const-wide/32&#x27;</span>, <span class="string">&#x27;const-wide&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;const-wide/high16&#x27;</span>, <span class="string">&#x27;const-string&#x27;</span>, <span class="string">&#x27;const-string/jumbo&#x27;</span>, <span class="string">&#x27;const-class&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;monitor-enter&#x27;</span>, <span class="string">&#x27;monitor-exit&#x27;</span>, <span class="string">&#x27;check-cast&#x27;</span>, <span class="string">&#x27;instance-of&#x27;</span>, <span class="string">&#x27;array-length&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;new-instance&#x27;</span>, <span class="string">&#x27;new-array&#x27;</span>, <span class="string">&#x27;filled-new-array&#x27;</span>, <span class="string">&#x27;fill-array-data&#x27;</span>, </span><br><span class="line">    <span class="string">&#x27;throw&#x27;</span>, <span class="string">&#x27;goto&#x27;</span>, <span class="string">&#x27;goto/16&#x27;</span>, <span class="string">&#x27;goto/32&#x27;</span>, <span class="string">&#x27;packed-switch&#x27;</span>, <span class="string">&#x27;sparse-switch&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;cmpl-float&#x27;</span>, <span class="string">&#x27;cmpg-float&#x27;</span>, <span class="string">&#x27;cmpl-double&#x27;</span>, <span class="string">&#x27;cmpg-double&#x27;</span>, <span class="string">&#x27;cmp-long&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;if-eq&#x27;</span>, <span class="string">&#x27;if-ne&#x27;</span>, <span class="string">&#x27;if-lt&#x27;</span>, <span class="string">&#x27;if-ge&#x27;</span>, <span class="string">&#x27;if-gt&#x27;</span>, <span class="string">&#x27;if-le&#x27;</span>, <span class="string">&#x27;if-eqz&#x27;</span>, <span class="string">&#x27;if-nez&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;if-ltz&#x27;</span>, <span class="string">&#x27;if-gez&#x27;</span>, <span class="string">&#x27;if-gtz&#x27;</span>, <span class="string">&#x27;if-lez&#x27;</span>, <span class="string">&#x27;aget&#x27;</span>, <span class="string">&#x27;aget-wide&#x27;</span>, <span class="string">&#x27;aget-object&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;aget-boolean&#x27;</span>, <span class="string">&#x27;aget-byte&#x27;</span>, <span class="string">&#x27;aget-char&#x27;</span>, <span class="string">&#x27;aget-short&#x27;</span>, <span class="string">&#x27;aput&#x27;</span>, <span class="string">&#x27;aput-wide&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;aput-object&#x27;</span>, <span class="string">&#x27;aput-boolean&#x27;</span>, <span class="string">&#x27;aput-byte&#x27;</span>, <span class="string">&#x27;aput-char&#x27;</span>, <span class="string">&#x27;aput-short&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iget&#x27;</span>, <span class="string">&#x27;iget-wide&#x27;</span>, <span class="string">&#x27;iget-object&#x27;</span>, <span class="string">&#x27;iget-boolean&#x27;</span>, <span class="string">&#x27;iget-byte&#x27;</span>, <span class="string">&#x27;iget-char&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iget-short&#x27;</span>, <span class="string">&#x27;iput&#x27;</span>, <span class="string">&#x27;iput-wide&#x27;</span>, <span class="string">&#x27;iput-object&#x27;</span>, <span class="string">&#x27;iput-boolean&#x27;</span>, <span class="string">&#x27;iput-byte&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;iput-char&#x27;</span>, <span class="string">&#x27;iput-short&#x27;</span>, <span class="string">&#x27;sget&#x27;</span>, <span class="string">&#x27;sget-wide&#x27;</span>, <span class="string">&#x27;sget-object&#x27;</span>, <span class="string">&#x27;sget-boolean&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sget-byte&#x27;</span>, <span class="string">&#x27;sget-char&#x27;</span>, <span class="string">&#x27;sget-short&#x27;</span>, <span class="string">&#x27;sput&#x27;</span>, <span class="string">&#x27;sput-wide&#x27;</span>, <span class="string">&#x27;sput-object&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sput-boolean&#x27;</span>, <span class="string">&#x27;sput-byte&#x27;</span>, <span class="string">&#x27;sput-char&#x27;</span>, <span class="string">&#x27;sput-short&#x27;</span>, <span class="string">&#x27;invoke-virtual&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;invoke-super&#x27;</span>, <span class="string">&#x27;invoke-direct&#x27;</span>, <span class="string">&#x27;invoke-static&#x27;</span>, <span class="string">&#x27;invoke-interface&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;invoke-virtual/range&#x27;</span>, <span class="string">&#x27;invoke-super/range&#x27;</span>, <span class="string">&#x27;invoke-direct/range&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;invoke-static/range&#x27;</span>, <span class="string">&#x27;invoke-interface/range&#x27;</span>, <span class="string">&#x27;neg-int&#x27;</span>, <span class="string">&#x27;neg-long&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;neg-float&#x27;</span>, <span class="string">&#x27;neg-double&#x27;</span>, <span class="string">&#x27;int-to-long&#x27;</span>, <span class="string">&#x27;int-to-float&#x27;</span>, <span class="string">&#x27;int-to-double&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;long-to-int&#x27;</span>, <span class="string">&#x27;long-to-float&#x27;</span>, <span class="string">&#x27;long-to-double&#x27;</span>, <span class="string">&#x27;float-to-int&#x27;</span>, <span class="string">&#x27;float-to-long&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;float-to-double&#x27;</span>, <span class="string">&#x27;double-to-int&#x27;</span>, <span class="string">&#x27;double-to-long&#x27;</span>, <span class="string">&#x27;double-to-float&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;int-to-byte&#x27;</span>, <span class="string">&#x27;int-to-char&#x27;</span>, <span class="string">&#x27;int-to-short&#x27;</span>, <span class="string">&#x27;add-int&#x27;</span>, <span class="string">&#x27;sub-int&#x27;</span>, <span class="string">&#x27;mul-int&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;div-int&#x27;</span>, <span class="string">&#x27;rem-int&#x27;</span>, <span class="string">&#x27;and-int&#x27;</span>, <span class="string">&#x27;or-int&#x27;</span>, <span class="string">&#x27;xor-int&#x27;</span>, <span class="string">&#x27;shl-int&#x27;</span>, <span class="string">&#x27;shr-int&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;ushr-int&#x27;</span>, <span class="string">&#x27;add-long&#x27;</span>, <span class="string">&#x27;sub-long&#x27;</span>, <span class="string">&#x27;mul-long&#x27;</span>, <span class="string">&#x27;div-long&#x27;</span>, <span class="string">&#x27;rem-long&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;and-long&#x27;</span>, <span class="string">&#x27;or-long&#x27;</span>, <span class="string">&#x27;xor-long&#x27;</span>, <span class="string">&#x27;shl-long&#x27;</span>, <span class="string">&#x27;shr-long&#x27;</span>, <span class="string">&#x27;ushr-long&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;add-float&#x27;</span>, <span class="string">&#x27;sub-float&#x27;</span>, <span class="string">&#x27;mul-float&#x27;</span>, <span class="string">&#x27;div-float&#x27;</span>, <span class="string">&#x27;rem-float&#x27;</span>, <span class="string">&#x27;add-double&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;sub-double&#x27;</span>, <span class="string">&#x27;mul-double&#x27;</span>, <span class="string">&#x27;div-double&#x27;</span>, <span class="string">&#x27;rem-double&#x27;</span></span><br><span class="line">])</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">decompile_apk</span>(<span class="params">apk_path, output_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;使用apktool反编译APK文件&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        subprocess.run(</span><br><span class="line">            [<span class="string">&#x27;apktool&#x27;</span>, <span class="string">&#x27;d&#x27;</span>, apk_path, <span class="string">&#x27;-o&#x27;</span>, output_dir, <span class="string">&#x27;-f&#x27;</span>],</span><br><span class="line">            check=<span class="literal">True</span>,</span><br><span class="line">            stdout=subprocess.DEVNULL,</span><br><span class="line">            stderr=subprocess.DEVNULL,</span><br><span class="line">            creationflags=get_creation_flags()</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">True</span></span><br><span class="line">    <span class="keyword">except</span> (subprocess.CalledProcessError, FileNotFoundError):</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">False</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">get_creation_flags</span>():</span><br><span class="line">    <span class="string">&quot;&quot;&quot;获取平台特定的进程创建标志&quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> sys.platform == <span class="string">&#x27;win32&#x27;</span>:</span><br><span class="line">        <span class="keyword">return</span> subprocess.CREATE_NO_WINDOW</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_opcode_vectors</span>(<span class="params">decompiled_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    从smali文件中提取操作码序列及分布向量</span></span><br><span class="line"><span class="string">    返回: (opcode_seq_fp, opcode_vector)</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    opcode_counter = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">    opcode_sequences = []</span><br><span class="line">    opcode_vector = &#123;opcode: <span class="number">0</span> <span class="keyword">for</span> opcode <span class="keyword">in</span> ALL_OPCODES&#125;</span><br><span class="line">    total_opcodes = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    smali_files = glob.glob(os.path.join(decompiled_dir, <span class="string">&#x27;smali**&#x27;</span>, <span class="string">&#x27;*.smali&#x27;</span>), recursive=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> smali_files:</span><br><span class="line">        <span class="keyword">return</span> <span class="string">&quot;&quot;</span>, opcode_vector</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> smali_file <span class="keyword">in</span> smali_files:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(smali_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                in_method = <span class="literal">False</span></span><br><span class="line">                current_seq = []</span><br><span class="line">                </span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    <span class="comment"># 检测方法开始</span></span><br><span class="line">                    <span class="keyword">if</span> line.startswith(<span class="string">&#x27;.method&#x27;</span>):</span><br><span class="line">                        in_method = <span class="literal">True</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 检测方法结束</span></span><br><span class="line">                    <span class="keyword">if</span> line.startswith(<span class="string">&#x27;.end method&#x27;</span>):</span><br><span class="line">                        <span class="keyword">if</span> current_seq:</span><br><span class="line">                            opcode_sequences.append(<span class="built_in">tuple</span>(current_seq))</span><br><span class="line">                            current_seq = []</span><br><span class="line">                        in_method = <span class="literal">False</span></span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 处理方法体</span></span><br><span class="line">                    <span class="keyword">if</span> in_method <span class="keyword">and</span> <span class="keyword">not</span> line.startswith((<span class="string">&#x27;.&#x27;</span>, <span class="string">&#x27;#&#x27;</span>)):</span><br><span class="line">                        <span class="comment"># 使用预编译正则提取操作码</span></span><br><span class="line">                        <span class="keyword">match</span> = OPCODE_PATTERN.<span class="keyword">match</span>(line.strip())</span><br><span class="line">                        <span class="keyword">if</span> <span class="keyword">match</span>:</span><br><span class="line">                            opcode = <span class="keyword">match</span>.group(<span class="number">1</span>)</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment"># 过滤伪操作码</span></span><br><span class="line">                            <span class="keyword">if</span> <span class="string">&#x27;:&#x27;</span> <span class="keyword">in</span> opcode <span class="keyword">or</span> opcode.startswith(<span class="string">&#x27;&quot;&#x27;</span>):</span><br><span class="line">                                <span class="keyword">continue</span></span><br><span class="line">                                </span><br><span class="line">                            <span class="comment"># 标准化操作码</span></span><br><span class="line">                            <span class="keyword">if</span> opcode.endswith(<span class="string">&#x27;&#125;&#x27;</span>) <span class="keyword">or</span> opcode.endswith(<span class="string">&#x27;)&#x27;</span>):</span><br><span class="line">                                opcode = re.split(<span class="string">r&#x27;[\&#123;\&#125;]&#x27;</span>, opcode)[<span class="number">0</span>]</span><br><span class="line">                            </span><br><span class="line">                            <span class="comment"># 添加到序列</span></span><br><span class="line">                            <span class="keyword">if</span> opcode <span class="keyword">in</span> ALL_OPCODES:</span><br><span class="line">                                current_seq.append(opcode)</span><br><span class="line">                                opcode_counter[opcode] += <span class="number">1</span></span><br><span class="line">                                total_opcodes += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 捕获方法结束但文件结束的情况</span></span><br><span class="line">                <span class="keyword">if</span> current_seq:</span><br><span class="line">                    opcode_sequences.append(<span class="built_in">tuple</span>(current_seq))</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            <span class="comment"># 记录错误但继续处理其他文件</span></span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成序列指纹</span></span><br><span class="line">    seq_hash = hashlib.sha256(json.dumps(opcode_sequences, sort_keys=<span class="literal">True</span>).encode()).hexdigest() <span class="keyword">if</span> opcode_sequences <span class="keyword">else</span> <span class="string">&quot;&quot;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 生成向量</span></span><br><span class="line">    <span class="keyword">if</span> total_opcodes &gt; <span class="number">0</span>:</span><br><span class="line">        <span class="keyword">for</span> opcode, count <span class="keyword">in</span> opcode_counter.items():</span><br><span class="line">            opcode_vector[opcode] = count / total_opcodes</span><br><span class="line">            </span><br><span class="line">    <span class="keyword">return</span> seq_hash, opcode_vector</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_control_flow_features</span>(<span class="params">decompiled_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从smali代码中提取控制流特征&quot;&quot;&quot;</span></span><br><span class="line">    cf_features = <span class="built_in">set</span>()</span><br><span class="line">    total_methods = <span class="number">0</span></span><br><span class="line">    branch_count = <span class="number">0</span></span><br><span class="line">    loop_count = <span class="number">0</span></span><br><span class="line">    exception_count = <span class="number">0</span></span><br><span class="line">    </span><br><span class="line">    smali_files = glob.glob(os.path.join(decompiled_dir, <span class="string">&#x27;smali**&#x27;</span>, <span class="string">&#x27;*.smali&#x27;</span>), recursive=<span class="literal">True</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> smali_files:</span><br><span class="line">        <span class="keyword">return</span> cf_features</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">for</span> smali_file <span class="keyword">in</span> smali_files:</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            <span class="keyword">with</span> <span class="built_in">open</span>(smali_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>, errors=<span class="string">&#x27;ignore&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">                <span class="keyword">for</span> line <span class="keyword">in</span> f:</span><br><span class="line">                    <span class="comment"># 统计方法数</span></span><br><span class="line">                    <span class="keyword">if</span> line.startswith(<span class="string">&#x27;.method&#x27;</span>):</span><br><span class="line">                        total_methods += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 分支指令</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;if-&#x27;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&#x27;goto&#x27;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&#x27;switch&#x27;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&#x27;packed-switch&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">                        branch_count += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 循环模式</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;loop&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">                        loop_count += <span class="number">1</span></span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 异常处理</span></span><br><span class="line">                    <span class="keyword">if</span> <span class="string">&#x27;.catch&#x27;</span> <span class="keyword">in</span> line <span class="keyword">or</span> <span class="string">&#x27;throw&#x27;</span> <span class="keyword">in</span> line:</span><br><span class="line">                        exception_count += <span class="number">1</span></span><br><span class="line">        <span class="keyword">except</span> Exception:</span><br><span class="line">            <span class="keyword">continue</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算并添加特征</span></span><br><span class="line">    <span class="keyword">if</span> total_methods &gt; <span class="number">0</span>:</span><br><span class="line">        cf_features.add(<span class="string">f&quot;CF_BRANCH_METHOD:<span class="subst">&#123;branch_count/total_methods:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        cf_features.add(<span class="string">f&quot;CF_LOOP_METHOD:<span class="subst">&#123;loop_count/total_methods:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">        cf_features.add(<span class="string">f&quot;CF_EXCEPT_METHOD:<span class="subst">&#123;exception_count/total_methods:<span class="number">.2</span>f&#125;</span>&quot;</span>)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> cf_features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_manifest_features</span>(<span class="params">manifest_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;从AndroidManifest.xml中提取特征&quot;&quot;&quot;</span></span><br><span class="line">    features = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> os.path.exists(manifest_path):</span><br><span class="line">        <span class="keyword">return</span> features</span><br><span class="line">        </span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(manifest_path, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            soup = BeautifulSoup(f.read(), <span class="string">&#x27;xml&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 权限</span></span><br><span class="line">            <span class="keyword">for</span> uses_perm <span class="keyword">in</span> soup.find_all(<span class="string">&#x27;uses-permission&#x27;</span>):</span><br><span class="line">                name = uses_perm.get(<span class="string">&#x27;android:name&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                <span class="keyword">if</span> name:</span><br><span class="line">                    features.add(<span class="string">f&#x27;PERMISSION:<span class="subst">&#123;name&#125;</span>&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 组件</span></span><br><span class="line">            comp_types = [<span class="string">&#x27;activity&#x27;</span>, <span class="string">&#x27;service&#x27;</span>, <span class="string">&#x27;receiver&#x27;</span>, <span class="string">&#x27;provider&#x27;</span>]</span><br><span class="line">            <span class="keyword">for</span> comp_type <span class="keyword">in</span> comp_types:</span><br><span class="line">                <span class="keyword">for</span> comp <span class="keyword">in</span> soup.find_all(comp_type):</span><br><span class="line">                    name = comp.get(<span class="string">&#x27;android:name&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> name:</span><br><span class="line">                        features.add(<span class="string">f&#x27;COMPONENT:<span class="subst">&#123;comp_type&#125;</span>:<span class="subst">&#123;name&#125;</span>&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 意图过滤器和元数据</span></span><br><span class="line">            <span class="keyword">for</span> intent_filter <span class="keyword">in</span> soup.find_all(<span class="string">&#x27;intent-filter&#x27;</span>):</span><br><span class="line">                <span class="keyword">for</span> action <span class="keyword">in</span> intent_filter.find_all(<span class="string">&#x27;action&#x27;</span>):</span><br><span class="line">                    name = action.get(<span class="string">&#x27;android:name&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> name:</span><br><span class="line">                        features.add(<span class="string">f&#x27;INTENT:<span class="subst">&#123;name&#125;</span>&#x27;</span>)</span><br><span class="line">                        </span><br><span class="line">            <span class="comment"># 应用元数据</span></span><br><span class="line">            application = soup.find(<span class="string">&#x27;application&#x27;</span>)</span><br><span class="line">            <span class="keyword">if</span> application:</span><br><span class="line">                meta_data = application.find_all(<span class="string">&#x27;meta-data&#x27;</span>)</span><br><span class="line">                <span class="keyword">for</span> meta <span class="keyword">in</span> meta_data:</span><br><span class="line">                    name = meta.get(<span class="string">&#x27;android:name&#x27;</span>, <span class="string">&#x27;&#x27;</span>)</span><br><span class="line">                    <span class="keyword">if</span> name:</span><br><span class="line">                        features.add(<span class="string">f&#x27;META:<span class="subst">&#123;name&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">        </span><br><span class="line">    <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_resource_file</span>(<span class="params">res_file, decompiled_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理单个资源文件并生成特征&quot;&quot;&quot;</span></span><br><span class="line">    features = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(res_file, <span class="string">&#x27;rb&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            file_hash = hashlib.sha256(f.read()).hexdigest()</span><br><span class="line">            rel_path = os.path.relpath(res_file, decompiled_dir)</span><br><span class="line">            features.add(<span class="string">f&#x27;RES_HASH:<span class="subst">&#123;rel_path&#125;</span>:<span class="subst">&#123;file_hash&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_layout_file</span>(<span class="params">layout_file</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理布局文件并生成特征&quot;&quot;&quot;</span></span><br><span class="line">    features = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> <span class="built_in">open</span>(layout_file, <span class="string">&#x27;r&#x27;</span>, encoding=<span class="string">&#x27;utf-8&#x27;</span>) <span class="keyword">as</span> f:</span><br><span class="line">            layout_type_count = defaultdict(<span class="built_in">int</span>)</span><br><span class="line">            layout_tree = []</span><br><span class="line">            </span><br><span class="line">            soup = BeautifulSoup(f.read(), <span class="string">&#x27;xml&#x27;</span>)</span><br><span class="line">            <span class="keyword">for</span> view <span class="keyword">in</span> soup.find_all(<span class="literal">True</span>):  <span class="comment"># True 查找所有标签</span></span><br><span class="line">                view_type = view.name.split(<span class="string">&#x27;.&#x27;</span>)[-<span class="number">1</span>]  <span class="comment"># 简化视图类型</span></span><br><span class="line">                layout_type_count[view_type] += <span class="number">1</span></span><br><span class="line">                </span><br><span class="line">                <span class="comment"># 视图深度</span></span><br><span class="line">                depth = <span class="built_in">len</span>(<span class="built_in">list</span>(view.parents)) - <span class="number">1</span></span><br><span class="line">                layout_tree.append(<span class="string">f&quot;<span class="subst">&#123;view_type&#125;</span>-<span class="subst">&#123;depth&#125;</span>&quot;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 添加布局特征</span></span><br><span class="line">            <span class="keyword">for</span> view_type, count <span class="keyword">in</span> layout_type_count.items():</span><br><span class="line">                features.add(<span class="string">f&#x27;LAYOUT_VIEW:<span class="subst">&#123;view_type&#125;</span>:<span class="subst">&#123;count&#125;</span>&#x27;</span>)</span><br><span class="line">            </span><br><span class="line">            <span class="comment"># 布局树结构指纹</span></span><br><span class="line">            <span class="keyword">if</span> layout_tree:</span><br><span class="line">                tree_hash = hashlib.sha256(<span class="string">&#x27;&#x27;</span>.join(layout_tree).encode()).hexdigest()</span><br><span class="line">                features.add(<span class="string">f&#x27;LAYOUT_TREE:<span class="subst">&#123;os.path.basename(layout_file)&#125;</span>:<span class="subst">&#123;tree_hash&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_resource_features</span>(<span class="params">apk_path, decompiled_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;提取增强版资源特征&quot;&quot;&quot;</span></span><br><span class="line">    features = <span class="built_in">set</span>()</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 1. AndroidManifest特征</span></span><br><span class="line">    manifest_path = os.path.join(decompiled_dir, <span class="string">&#x27;AndroidManifest.xml&#x27;</span>)</span><br><span class="line">    features |= extract_manifest_features(manifest_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 2. 资源文件哈希</span></span><br><span class="line">    resource_files = []</span><br><span class="line">    res_dir = os.path.join(decompiled_dir, <span class="string">&#x27;res&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(res_dir):</span><br><span class="line">        <span class="keyword">for</span> root, _, files <span class="keyword">in</span> os.walk(res_dir):</span><br><span class="line">            <span class="keyword">for</span> file <span class="keyword">in</span> files:</span><br><span class="line">                <span class="keyword">if</span> file.endswith((<span class="string">&#x27;.xml&#x27;</span>, <span class="string">&#x27;.png&#x27;</span>, <span class="string">&#x27;.jpg&#x27;</span>, <span class="string">&#x27;.webp&#x27;</span>, <span class="string">&#x27;.otf&#x27;</span>, <span class="string">&#x27;.ttf&#x27;</span>)):</span><br><span class="line">                    resource_files.append(os.path.join(root, file))</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">for</span> res_file <span class="keyword">in</span> resource_files:</span><br><span class="line">        features |= process_resource_file(res_file, decompiled_dir)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 3. 布局文件结构分析</span></span><br><span class="line">    layout_dir = os.path.join(decompiled_dir, <span class="string">&#x27;res&#x27;</span>, <span class="string">&#x27;layout&#x27;</span>)</span><br><span class="line">    <span class="keyword">if</span> os.path.exists(layout_dir):</span><br><span class="line">        layout_files = glob.glob(os.path.join(layout_dir, <span class="string">&#x27;*.xml&#x27;</span>))</span><br><span class="line">        <span class="keyword">for</span> layout_file <span class="keyword">in</span> layout_files:</span><br><span class="line">            features |= process_layout_file(layout_file)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">extract_native_libs</span>(<span class="params">apk_path</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;提取原生库特征&quot;&quot;&quot;</span></span><br><span class="line">    features = <span class="built_in">set</span>()</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">        <span class="keyword">with</span> zipfile.ZipFile(apk_path, <span class="string">&#x27;r&#x27;</span>) <span class="keyword">as</span> z:</span><br><span class="line">            so_files = [name <span class="keyword">for</span> name <span class="keyword">in</span> z.namelist() </span><br><span class="line">                        <span class="keyword">if</span> name.startswith(<span class="string">&#x27;lib/&#x27;</span>) <span class="keyword">and</span> name.endswith(<span class="string">&#x27;.so&#x27;</span>)]</span><br><span class="line">            </span><br><span class="line">            <span class="keyword">for</span> so_name <span class="keyword">in</span> so_files:</span><br><span class="line">                <span class="keyword">with</span> z.<span class="built_in">open</span>(so_name) <span class="keyword">as</span> so_file:</span><br><span class="line">                    <span class="comment"># ELF头特征</span></span><br><span class="line">                    header = so_file.read(<span class="number">32</span>)</span><br><span class="line">                    <span class="keyword">if</span> <span class="built_in">len</span>(header) &lt; <span class="number">32</span>:</span><br><span class="line">                        <span class="keyword">continue</span></span><br><span class="line">                    </span><br><span class="line">                    ei_class = header[<span class="number">4</span>]</span><br><span class="line">                    ei_data = header[<span class="number">5</span>]</span><br><span class="line">                    e_machine = header[<span class="number">18</span>:<span class="number">20</span>]</span><br><span class="line">                    </span><br><span class="line">                    features.add(<span class="string">f&#x27;ELF_CLASS:<span class="subst">&#123;ei_class&#125;</span>&#x27;</span>)</span><br><span class="line">                    features.add(<span class="string">f&#x27;ELF_DATA:<span class="subst">&#123;ei_data&#125;</span>&#x27;</span>)</span><br><span class="line">                    features.add(<span class="string">f&#x27;ELF_MACHINE:<span class="subst">&#123;<span class="built_in">int</span>.from_bytes(e_machine, <span class="string">&quot;little&quot;</span>)&#125;</span>&#x27;</span>)</span><br><span class="line">                    </span><br><span class="line">                    <span class="comment"># 节头特征</span></span><br><span class="line">                    so_file.seek(<span class="number">0</span>)</span><br><span class="line">                    data = so_file.read(<span class="number">4096</span>)</span><br><span class="line">                    section_names = <span class="built_in">set</span>(ELF_SECTION_PATTERN.findall(data))</span><br><span class="line">                    <span class="keyword">for</span> name <span class="keyword">in</span> section_names:</span><br><span class="line">                        features.add(<span class="string">f&#x27;ELF_SECTION:<span class="subst">&#123;name.decode()&#125;</span>&#x27;</span>)</span><br><span class="line">    <span class="keyword">except</span> Exception:</span><br><span class="line">        <span class="keyword">pass</span></span><br><span class="line">    <span class="keyword">return</span> features</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">create_minhash</span>(<span class="params">features, num_perm=NUM_PERM</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;创建MinHash对象&quot;&quot;&quot;</span></span><br><span class="line">    m = MinHash(num_perm=num_perm)</span><br><span class="line">    <span class="keyword">for</span> feature <span class="keyword">in</span> features:</span><br><span class="line">        m.update(feature.encode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">    <span class="keyword">return</span> m</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_opcode_similarity</span>(<span class="params">vec1, vec2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算操作码向量的余弦相似度&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 获取操作码并集</span></span><br><span class="line">    all_opcodes = <span class="built_in">set</span>(vec1.keys()) | <span class="built_in">set</span>(vec2.keys())</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 创建等长向量</span></span><br><span class="line">    v1 = np.array([vec1.get(op, <span class="number">0</span>) <span class="keyword">for</span> op <span class="keyword">in</span> all_opcodes])</span><br><span class="line">    v2 = np.array([vec2.get(op, <span class="number">0</span>) <span class="keyword">for</span> op <span class="keyword">in</span> all_opcodes])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 计算余弦相似度</span></span><br><span class="line">    similarity = cosine_similarity([v1], [v2])[<span class="number">0</span>][<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">max</span>(<span class="number">0.0</span>, <span class="built_in">min</span>(similarity, <span class="number">1.0</span>))</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">process_apk</span>(<span class="params">apk_path, decompile_dir</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;处理单个APK并提取所有特征&quot;&quot;&quot;</span></span><br><span class="line">    <span class="built_in">print</span>(<span class="string">f&quot;Decompiling &#x27;<span class="subst">&#123;apk_path&#125;</span>&#x27;...&quot;</span>)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> decompile_apk(apk_path, decompile_dir):</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;Failed to decompile <span class="subst">&#123;apk_path&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">None</span></span><br><span class="line">        </span><br><span class="line">    <span class="built_in">print</span>(<span class="string">&quot;Extracting features...&quot;</span>)</span><br><span class="line">    <span class="comment"># 资源特征</span></span><br><span class="line">    res_features = extract_resource_features(apk_path, decompile_dir)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 原生库特征</span></span><br><span class="line">    native_features = extract_native_libs(apk_path)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 控制流特征</span></span><br><span class="line">    cf_features = extract_control_flow_features(decompile_dir)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 操作码特征</span></span><br><span class="line">    opcode_seq, opcode_vec = extract_opcode_vectors(decompile_dir)</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> &#123;</span><br><span class="line">        <span class="string">&#x27;res_features&#x27;</span>: res_features,</span><br><span class="line">        <span class="string">&#x27;native_features&#x27;</span>: native_features,</span><br><span class="line">        <span class="string">&#x27;cf_features&#x27;</span>: cf_features,</span><br><span class="line">        <span class="string">&#x27;opcode_seq&#x27;</span>: opcode_seq,</span><br><span class="line">        <span class="string">&#x27;opcode_vec&#x27;</span>: opcode_vec</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">calculate_similarities</span>(<span class="params">data1, data2</span>):</span><br><span class="line">    <span class="string">&quot;&quot;&quot;计算所有相似度指标&quot;&quot;&quot;</span></span><br><span class="line">    <span class="comment"># 组合所有特征</span></span><br><span class="line">    all_features1 = (</span><br><span class="line">        data1[<span class="string">&#x27;res_features&#x27;</span>] | </span><br><span class="line">        data1[<span class="string">&#x27;native_features&#x27;</span>] | </span><br><span class="line">        data1[<span class="string">&#x27;cf_features&#x27;</span>] | </span><br><span class="line">        &#123;<span class="string">f&#x27;OPSEQ:<span class="subst">&#123;data1[<span class="string">&quot;opcode_seq&quot;</span>]&#125;</span>&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    all_features2 = (</span><br><span class="line">        data2[<span class="string">&#x27;res_features&#x27;</span>] | </span><br><span class="line">        data2[<span class="string">&#x27;native_features&#x27;</span>] | </span><br><span class="line">        data2[<span class="string">&#x27;cf_features&#x27;</span>] | </span><br><span class="line">        &#123;<span class="string">f&#x27;OPSEQ:<span class="subst">&#123;data2[<span class="string">&quot;opcode_seq&quot;</span>]&#125;</span>&#x27;</span>&#125;</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 结构相似度 (MinHash)</span></span><br><span class="line">    minhash_all1 = create_minhash(all_features1)</span><br><span class="line">    minhash_all2 = create_minhash(all_features2)</span><br><span class="line">    structure_sim = minhash_all1.jaccard(minhash_all2)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 操作码相似度</span></span><br><span class="line">    opcode_sim = calculate_opcode_similarity(data1[<span class="string">&#x27;opcode_vec&#x27;</span>], data2[<span class="string">&#x27;opcode_vec&#x27;</span>])</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 资源相似度</span></span><br><span class="line">    minhash_res1 = create_minhash(data1[<span class="string">&#x27;res_features&#x27;</span>])</span><br><span class="line">    minhash_res2 = create_minhash(data2[<span class="string">&#x27;res_features&#x27;</span>])</span><br><span class="line">    resource_sim = minhash_res1.jaccard(minhash_res2)</span><br><span class="line">    </span><br><span class="line">    <span class="comment"># 加权综合相似度</span></span><br><span class="line">    weighted_sim = (</span><br><span class="line">        OPCODE_SIM_WEIGHT * opcode_sim +</span><br><span class="line">        STRUCTURE_SIM_WEIGHT * structure_sim +</span><br><span class="line">        RESOURCE_SIM_WEIGHT * resource_sim</span><br><span class="line">    )</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">return</span> opcode_sim, structure_sim, resource_sim, weighted_sim</span><br><span class="line"></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">main</span>(<span class="params">apk_path1, apk_path2</span>):</span><br><span class="line">    <span class="comment"># 创建临时目录</span></span><br><span class="line">    <span class="keyword">with</span> tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir1, tempfile.TemporaryDirectory() <span class="keyword">as</span> tmpdir2:</span><br><span class="line">        data1 = process_apk(apk_path1, tmpdir1)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data1:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        data2 = process_apk(apk_path2, tmpdir2)</span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> data2:</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">            </span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nCalculating similarities...&quot;</span>)</span><br><span class="line">        opcode_sim, structure_sim, resource_sim, weighted_sim = calculate_similarities(data1, data2)</span><br><span class="line"></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\n&quot;</span> + <span class="string">&quot;=&quot;</span>*<span class="number">85</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Similarity Report:&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Opcode Sequence Similarity: <span class="subst">&#123;opcode_sim:<span class="number">.4</span>f&#125;</span>  (Bytecode patterns)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Structural Similarity:      <span class="subst">&#123;structure_sim:<span class="number">.4</span>f&#125;</span>  (Resources/Control-Flow/Native)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Resource Similarity:        <span class="subst">&#123;resource_sim:<span class="number">.4</span>f&#125;</span>  (Manifest/Assets)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;-&quot;</span>*<span class="number">85</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">f&quot;  Weighted Similarity Score:  <span class="subst">&#123;weighted_sim:<span class="number">.4</span>f&#125;</span> (Opcode: <span class="subst">&#123;OPCODE_SIM_WEIGHT&#125;</span>w, Structural: <span class="subst">&#123;STRUCTURE_SIM_WEIGHT&#125;</span>w, Resource: <span class="subst">&#123;RESOURCE_SIM_WEIGHT&#125;</span>w)&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;=&quot;</span>*<span class="number">85</span>)</span><br><span class="line">        </span><br><span class="line">        <span class="comment"># 相似度解读</span></span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;\nInterpretation:&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> weighted_sim &gt; <span class="number">0.9</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;CRITICAL ALERT: Applications are nearly identical (high probability clone)&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> weighted_sim &gt; <span class="number">0.75</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;HIGH SIMILARITY: Significant code reuse detected (possible modified clone)&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> weighted_sim &gt; <span class="number">0.6</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;MODERATE SIMILARITY: Shared components/libraries (legitimate or borrowed)&quot;</span>)</span><br><span class="line">        <span class="keyword">elif</span> weighted_sim &gt; <span class="number">0.4</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;LOW SIMILARITY: Minor similarities detected (common frameworks)&quot;</span>)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="built_in">print</span>(<span class="string">&quot;MINIMAL SIMILARITY: Applications appear substantially different&quot;</span>)    </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">len</span>(sys.argv) != <span class="number">3</span>:</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Usage: python apk_sim.py &lt;apk1&gt; &lt;apk2&gt;&quot;</span>)</span><br><span class="line">        <span class="built_in">print</span>(<span class="string">&quot;Example: python apk_sim.py hy.apk fl.apk&quot;</span>)</span><br><span class="line">        sys.exit(<span class="number">1</span>)</span><br><span class="line">    </span><br><span class="line">    main(sys.argv[<span class="number">1</span>], sys.argv[<span class="number">2</span>])</span><br></pre></td></tr></table></figure>
  </div>
  
    
      <a id="older" class="blog-nav" href="/posts/pg-dict-gen/">OLDER&nbsp;&gt;</a>
    
    
      <a id="newer" class="blog-nav" href="/posts/apk-stats/">&lt;&nbsp;NEWER</a>
    
  
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        © 2016-2025 Kanpu Li. All rights reserved.
        
    </div>
  
</div>

      </div>
      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>


<script src="/js/table.js"></script>


      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)" aria-label="搜索...">
      <i class="iconfont icon-search" aria-hidden="true"></i>
    </a>
  </div>

  <div class="search-overlay hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          
            <input type="text" class="search-input" id="search-input" placeholder="请输入要搜索的内容" aria-label="请输入要搜索的内容">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)" aria-label="Close">
              <i class="iconfont icon-close" aria-hidden="true"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"
             data-i18n-noresult="无相关内容"
             data-i18n-files-notfound="未找到search.xml文件，具体请参考："
             data-i18n-service-errors="请求失败，尝试重新刷新页面或稍后重试"></div>
      </div>
    </div>
  </div>

  
<script src="/js/search.js"></script>



    </div>
  </body>
</html>
