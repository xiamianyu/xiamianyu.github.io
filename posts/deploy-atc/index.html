<!DOCTYPE html>
<html lang="zh-CN">
  <head>
  

  <title>搭建Facebook ATC</title>

  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  
    <link rel="icon" href="/images/favicon.webp">
  

  <link rel="preload" href="/fonts/Montserrat.woff2" as="font" type="font/woff2" crossorigin>
  <link rel="preload" href="/fonts/RobotoMono.woff2" as="font" type="font/woff2" crossorigin>

  <!-- site css -->
  
<link rel="stylesheet" href="/css/fonts.css">
<link rel="stylesheet" href="/css/base.css">
<link rel="stylesheet" href="/css/common.css">
<link rel="stylesheet" href="/iconfont/iconfont.css">


  

  
    
<link rel="stylesheet" href="/css/post.css">

  

  <link href="/vendor/fancybox/5.0.36/fancybox.css" rel="stylesheet">
  <script src="/vendor/fancybox/5.0.36/fancybox.umd.js" defer></script>
  
<script src="/js/fancybox.js"></script>


  
    <script>
      window.__mermaidInitConfig = {
        theme: 'default'
      };
    </script>
    <script src='/vendor/mermaid/11.12.0/mermaid.min.js' defer onload="try{if(window.mermaid){ mermaid.initialize(window.__mermaidInitConfig); }}catch(e){}"></script>
  
<meta name="generator" content="Hexo 7.3.0"><link rel="alternate" href="/atom.xml" title="夏眠鱼" type="application/atom+xml">
</head>
  <body>
    <div id="app">
      <div class="header">
  <a href="/">夏眠鱼</a>
</div>


      <p class="links">
  
    <a title="archives" target="" href="/archives/">
      <i class="iconfont icon-bookmark"></i>
    </a>
  
    <a title="tags" target="" href="/tags/">
      <i class="iconfont icon-tags"></i>
    </a>
  
    <a title="about" target="" href="/about/">
      <i class="iconfont icon-envelope"></i>
    </a>
  
</p>

      <div class="main">
        <script>
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']]
    },
    options: {
      skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
    }
  };
</script>
<script id="MathJax-script" src="/vendor/mathjax/3.2.2/es5/tex-chtml.js" defer></script>

<div class="post">
  <div class="date-tags-container">
    <h3 class="date">
      Aug 27, 2021
    </h3>
    
      <div class="post-tags">
        
          <a href="/tags/net/" class="tag-link">net</a>
        
      </div>
    
  </div>
  <h1>
    搭建Facebook ATC
  </h1>
  <div class="content markdown-body">
    <p>搭建Facebook ATC（简称ATC）的首要条件是主机能发射热点，笔记本一般标配无线网卡，PC没有无线网卡的需要买一个。</p>
<p>我的搭建方案是<code>VirtualBox + Ubuntu-Desktop + USB无线网卡</code>，通过VirtualBox的USB选项，把无线网卡挂载到Ubuntu上。</p>
<p>创建虚拟机时，网络连接模式一般选用NAT或桥接，我用桥接模式，这样手机连了热点就能访问内外网。虚拟机网络连接模式如下：</p>
<table>
<thead>
<tr>
<th align="center">Model</th>
<th align="center">VM &gt; Host</th>
<th align="center">Host &gt; VM</th>
<th align="center">VM &lt; &gt; VM</th>
<th align="center">VM &gt; Internet</th>
<th align="center">Internet &gt; VM</th>
</tr>
</thead>
<tbody><tr>
<td align="center">Bridged</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">+</td>
</tr>
<tr>
<td align="center">NAT</td>
<td align="center">+</td>
<td align="center">Port Forwarding</td>
<td align="center">-</td>
<td align="center">+</td>
<td align="center">Port Forwarding</td>
</tr>
<tr>
<td align="center">NAT Network</td>
<td align="center">+</td>
<td align="center">Port Forwarding</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">Port Forwarding</td>
</tr>
<tr>
<td align="center">Host-only</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">+</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
<tr>
<td align="center">Internal</td>
<td align="center">-</td>
<td align="center">-</td>
<td align="center">+</td>
<td align="center">-</td>
<td align="center">-</td>
</tr>
</tbody></table>
<p>我的无线网卡是<code>COMFAST CF-811AC</code>，从官网下载的驱动安装失败，后来在GitHub上发现有它的<a target="_blank" rel="noopener" href="https://github.com/brektrou/rtl8821CU">驱动源码</a>，下载下来编译安装就可以了，重启Ubuntu生效。通过<code>ifconfig</code>命令，看到<code>wlx200db04f5f01</code>就说明无线网卡能用了。</p>
<figure class="highlight apache"><table><tr><td class="code"><pre><span class="line"><span class="attribute">enp0s3</span>: flags=<span class="number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        <span class="attribute">inet</span> <span class="number">192.168.0.207</span>  netmask <span class="number">255.255.252.0</span>  broadcast <span class="number">192.168.3.255</span></span><br><span class="line">        <span class="attribute">inet6</span> fe80::<span class="number">32</span>dd:f717:<span class="number">7</span>b29:cee9  prefixlen <span class="number">64</span>  scopeid <span class="number">0</span>x20&lt;link&gt;</span><br><span class="line">        <span class="attribute">ether</span> <span class="number">08</span>:<span class="number">00</span>:<span class="number">27</span>:<span class="number">0</span>b:<span class="number">7</span>e:<span class="number">65</span>  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">442428</span>  bytes <span class="number">417116093</span> (<span class="number">417</span>.<span class="number">1</span> MB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">168300</span>  bytes <span class="number">21261861</span> (<span class="number">21</span>.<span class="number">2</span> MB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">lo</span>: flags=<span class="number">73</span>&lt;UP,LOOPBACK,RUNNING&gt;  mtu <span class="number">65536</span></span><br><span class="line">        <span class="attribute">inet</span> <span class="number">127.0.0.1</span>  netmask <span class="number">255.0.0.0</span></span><br><span class="line">        <span class="attribute">inet6</span> ::<span class="number">1</span>  prefixlen <span class="number">128</span>  scopeid <span class="number">0</span>x10&lt;host&gt;</span><br><span class="line">        <span class="attribute">loop</span>  txqueuelen <span class="number">1000</span>  (Local Loopback)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">11430</span>  bytes <span class="number">948726</span> (<span class="number">948</span>.<span class="number">7</span> KB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">0</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">11430</span>  bytes <span class="number">948726</span> (<span class="number">948</span>.<span class="number">7</span> KB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">0</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="attribute">wlx200db04f5f01</span>: flags=<span class="number">4163</span>&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu <span class="number">1500</span></span><br><span class="line">        <span class="attribute">inet</span> <span class="number">10.42.0.1</span>  netmask <span class="number">255.255.255.0</span>  broadcast <span class="number">10.42.0.255</span></span><br><span class="line">        <span class="attribute">inet6</span> fe80::<span class="number">220</span>d:b0ff:fe4f:<span class="number">5</span>f01  prefixlen <span class="number">64</span>  scopeid <span class="number">0</span>x20&lt;link&gt;</span><br><span class="line">        <span class="attribute">ether</span> <span class="number">20</span>:<span class="number">0</span>d:b0:<span class="number">4</span>f:<span class="number">5</span>f:<span class="number">01</span>  txqueuelen <span class="number">1000</span>  (Ethernet)</span><br><span class="line">        <span class="attribute">RX</span> packets <span class="number">162441</span>  bytes <span class="number">25230166</span> (<span class="number">25</span>.<span class="number">2</span> MB)</span><br><span class="line">        <span class="attribute">RX</span> errors <span class="number">0</span>  dropped <span class="number">40</span>  overruns <span class="number">0</span>  frame <span class="number">0</span></span><br><span class="line">        <span class="attribute">TX</span> packets <span class="number">305575</span>  bytes <span class="number">403071992</span> (<span class="number">403</span>.<span class="number">0</span> MB)</span><br><span class="line">        <span class="attribute">TX</span> errors <span class="number">0</span>  dropped <span class="number">2953</span> overruns <span class="number">0</span>  carrier <span class="number">0</span>  collisions <span class="number">0</span></span><br></pre></td></tr></table></figure>

<p>接下来就是设置热点。通过<code>nm-connection-editor</code>命令打开网络连接管理界面，将WiFi设置为热点模式，如果不想热点的信道被干扰，可以选择5G频段，但是一些老的手机是搜不到5G频段的，这个自己权衡一下。热点发射成功后，手机连上热点，看能否使用内外网，没问题就可以往下走。</p>
<p>根据官方的<a target="_blank" rel="noopener" href="https://github.com/facebookarchive/augmented-traffic-control">教程</a>，我们必须先安装好Python2-pip才能把ATC安装好。前面我也说了，ATC是爷爷辈的项目，比较老，直接<code>sudo apt-get install python-pip</code>是安装不了的，还好一个好心的哥哥写了<a target="_blank" rel="noopener" href="https://blog.csdn.net/drivery/article/details/108823167">教程</a>：</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 首先启用Universe存储库</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">add-apt-repository</span> <span class="string">universe</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 更新程序包索引并安装Python2</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">update</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">apt</span> <span class="string">install</span> <span class="string">python</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 使用curl下载get-pip.py脚本</span></span><br><span class="line"><span class="string">curl</span> <span class="string">https</span>://<span class="string">bootstrap</span>.<span class="string">pypa</span>.<span class="string">io</span>/<span class="built_in">get-pip.py</span> <span class="built_in">--output</span> <span class="built_in">get-pip.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装pip</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">python</span> <span class="built_in">get-pip.py</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 查看pip版本</span></span><br><span class="line"><span class="string">pip</span> <span class="built_in">--version</span></span><br></pre></td></tr></table></figure>

<p>pip安装成功后，你离成功就不远了。我们继续：</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装ATC</span></span><br><span class="line"><span class="built_in">sudo</span> pip install atc_thrift atcd django-atc-api django-atc-demo-ui django-atc-profile-storage</span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建atcui</span></span><br><span class="line"><span class="built_in">sudo</span> django-admin startproject atcui</span><br></pre></td></tr></table></figure>

<p>打开<code>atcui/settings.py</code>，添加以下配置项：</p>
<figure class="highlight dockerfile"><table><tr><td class="code"><pre><span class="line">ALLOWED_HOSTS = [<span class="string">&#x27;*&#x27;</span>]</span><br><span class="line">INSTALLED_APPS = (</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># Django ATC API</span></span><br><span class="line">    <span class="string">&#x27;rest_framework&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;atc_api&#x27;</span>,</span><br><span class="line">    <span class="comment"># Django ATC Demo UI</span></span><br><span class="line">    <span class="string">&#x27;bootstrap_themes&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;django_static_jquery&#x27;</span>,</span><br><span class="line">    <span class="string">&#x27;atc_demo_ui&#x27;</span>,</span><br><span class="line">    <span class="comment"># Django ATC Profile Storage</span></span><br><span class="line">    <span class="string">&#x27;atc_profile_storage&#x27;</span>,</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>打开atcui&#x2F;urls.py，添加以下配置项：</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="keyword">from</span> django.views.generic.base <span class="keyword">import</span> RedirectView</span><br><span class="line"><span class="keyword">from</span> django.conf.urls <span class="keyword">import</span> include</span><br><span class="line"></span><br><span class="line">urlpatterns = [</span><br><span class="line">    ...</span><br><span class="line">    <span class="comment"># Django ATC API</span></span><br><span class="line">    url(<span class="string">r&#x27;^api/v1/&#x27;</span>, include(<span class="string">&#x27;atc_api.urls&#x27;</span>)),</span><br><span class="line">    <span class="comment"># Django ATC Demo UI</span></span><br><span class="line">    url(<span class="string">r&#x27;^atc_demo_ui/&#x27;</span>, include(<span class="string">&#x27;atc_demo_ui.urls&#x27;</span>)),</span><br><span class="line">    <span class="comment"># Django ATC profile storage</span></span><br><span class="line">    url(<span class="string">r&#x27;^api/v1/profiles/&#x27;</span>, include(<span class="string">&#x27;atc_profile_storage.urls&#x27;</span>)),</span><br><span class="line">    url(<span class="string">r&#x27;^$&#x27;</span>, RedirectView.as_view(url=<span class="string">&#x27;/atc_demo_ui/&#x27;</span>, permanent=<span class="literal">False</span>)),</span><br><span class="line">]</span><br></pre></td></tr></table></figure>

<p>更新数据库</p>
<figure class="highlight vim"><table><tr><td class="code"><pre><span class="line">sudo <span class="keyword">python</span> manage.<span class="keyword">py</span> migrate</span><br></pre></td></tr></table></figure>

<p>启动atcd</p>
<figure class="highlight dsconfig"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 用虚拟机搭建ATC，atcd需要指定wan和lan</span></span><br><span class="line"><span class="string">sudo</span> <span class="string">atcd</span> <span class="built_in">--atcd-wan</span> <span class="string">enp0s3</span> <span class="built_in">--atcd-lan</span> <span class="string">wlx200db04f5f01</span></span><br></pre></td></tr></table></figure>

<p>启动atcui</p>
<figure class="highlight nginx"><table><tr><td class="code"><pre><span class="line"><span class="attribute">python</span> manage.py runserver <span class="number">0.0.0.0:8000</span></span><br></pre></td></tr></table></figure>

<p>到这里，ATC就搭建好了。通过<code>ifconfig</code>找到无线网卡的inet，比如IP是<code>10.42.0.1</code>，浏览器输入<code>10.42.0.1:8000</code>即可访问。</p>
<p>如果不想自己配置网络类型，可以使用官方默认的：</p>
<ul>
<li>2G - Developing Rural</li>
<li>2G - Developing Urban</li>
<li>3G - Average</li>
<li>3G - Good</li>
<li>Cable</li>
<li>DSL</li>
<li>Edge - Average</li>
<li>Edge - Good</li>
<li>Edge - Lossy</li>
<li>No Connectivity</li>
</ul>
<p>配置官方默认的网络类型</p>
<figure class="highlight stata"><table><tr><td class="code"><pre><span class="line">utils/<span class="keyword">restore</span>-profiles.<span class="keyword">sh</span> 0.0.0.0:8000</span><br></pre></td></tr></table></figure>





  </div>
  
    
      <a id="older" class="blog-nav" href="/posts/1v1-call-flow/">OLDER&nbsp;&gt;</a>
    
    
      <a id="newer" class="blog-nav" href="/posts/about-packet/">&lt;&nbsp;NEWER</a>
    
  
</div>
        <div class="footer">
  
    <div class="footer-more">
      
        © 2016-2025 Kanpu Li. All rights reserved.
        
    </div>
  
</div>

      </div>
      <div class="back-to-top hidden">
  <a href="javascript: void(0)">
    <i class="iconfont icon-chevronup"></i>
  </a>
</div>


<script src="/js/backtotop.js"></script>


<script src="/js/table.js"></script>


      
  <div class="search-icon" id="search-icon">
    <a href="javascript: void(0)" aria-label="搜索...">
      <i class="iconfont icon-search" aria-hidden="true"></i>
    </a>
  </div>

  <div class="search-overlay hidden" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="search-content" tabindex="0">
      <div class="search-box">
        <div class="search-title">
          
            <input type="text" class="search-input" id="search-input" placeholder="请输入要搜索的内容" aria-label="请输入要搜索的内容">
          
          <span class="search-close-icon" id="search-close-icon">
            <a href="javascript: void(0)" aria-label="Close">
              <i class="iconfont icon-close" aria-hidden="true"></i>
            </a>
          </span>
        </div>
        <div class="search-result" id="search-result"
             data-i18n-noresult="无相关内容"
             data-i18n-files-notfound="未找到search.xml文件，具体请参考："
             data-i18n-service-errors="请求失败，尝试重新刷新页面或稍后重试"></div>
      </div>
    </div>
  </div>

  
<script src="/js/search.js"></script>



    </div>
  </body>
</html>
